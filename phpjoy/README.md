# PHPJoy 

[![release](https://github.com/EnhancedPHPJoern/PHPJoy/actions/workflows/gradle.yml/badge.svg)](https://github.com/EnhancedPHPJoern/PHPJoy/actions/workflows/gradle.yml)

## Introduction

Joern is a platform for analyzing source code, bytecode, and binary executables. It generates code property graphs (
CPGs), a graph representation of code for cross-language code analysis. Code property graphs are stored in a custom
graph database.

Here we implement the new version for PHPJoern, aiming at supporting more various of semantic information , more precise
data/control-flow analysis and more friendly program-analysis apis.

## Requirements

- JDK 11 with gradle
- PHP 7.4 with composer & php-ast & php-mbstring
- Neo4j-Community 4.x

## Project Overview

The structure of release version is shown as follows:

```text
├── build.py
├── php2ast
   └── src
├── phpast2cpg.jar
├── php2ast.sh
├── phpast2cpg.sh
├── neo4j-admin-import.sh

``` 

- build.py & *.sh : an useful script to build the neo4j quickly
- php2ast : the released code of php2ast part , it will analyze php source code and dumped them into ast trees
- phpast2cpg.jar : the release binary of phpast2cpg part , it will analyze the ast trees and add semantic information to
  graph.

## Installation

### Build from release version

You can visit the release page to get the latest release version.

```shell
wget https://github.com/EnhancedPHPJoern/PHPJoy/releases/download/latest/phpjoy.tar.gz
tar -zxvf phpjoy.tar.gz
```

### Build from source

#### php2ast part

Ensure you has install `php7.4` and composer , remember to open exentension for `php-ast` and `php-mbstring`

```shell
cd php2ast/src/
composer install
```

#### phpast2cpg Part

```shell
$ gradle  -q ":joern-php:fatJar" 
$ mv joern-php/build/libs/phpast2cpg.jar .
```

## Usage

### Simple Usage

You can use build.py to build the database.
Note that this script will automatically download the neo4j-4.4.4 in the upper directory, and generate a database with
the name of <source_code_dir> in the upper directory.

```shell
 python build.py <source_code_dir> <bolt_port> <http_port>
```

### Advanced Usage for each tools

The data will be dumped into 5 csv files

- nodes.csv(generated by php2ast tool) contains all AST & File nodes in source_code's AST trees.
- rels.csv(generated by php2ast tool) contains all AST edges in source_code's AST trees.
- cpg_edges.csv(generated by phpast2cpg tool) contains all CFG\PDG\CG\FIG\CHG edges.
- fake_nodes.csv(generated by phpast2cpg tool) contains fake nodes of built-in function\classes. For `relax` mode of phpast2cpg part ,it also will contain the definition of FakeAst nodes
- fake_rels.csv(generated by phpast2cpg tool) contains fake edge CG\CHG of built-in function\classes. For `relax` mode of phpast2cpg part ,it also will contain some edges linked between AST nodes and FakeAst nodes.

**php2ast**

`./php2ast/src/Parser.php` or `./php2ast.sh` is the command-cli for **php2ast** tool.

```shell
$ php ./php2ast/src/Parser.php --help
$ # or you can use ./php2ast.sh --help
Usage: php .\php2ast\src\Parser.php [options] <file|folder>

Options:
  -h, --help                 Display help message
  -n, --nodes <file>         Output file for nodes (default: nodes.csv)
  -r, --relationships <file> Output file for relationships (default: rels.csv)
```

**phpast2cpg**

`phpast2cpg.jar` is the command-cli for **phpast2cpg** tool.


```shell
$ java -jar ./phpast2cpg.jar --help
usage:  <nodes.csv> <rels.csv> [relax | strict(default)] <const map>
-e,--edge <arg>         The edge file (edges.csv as default)
-m,--mode               mode , strict or relax (strict as default)
-n,--node <arg>         The node file (nodes.csv as default)
-noCG                   close cg generation , save time but lose information (false as default)
-noCHG                  close chg generation , save time but lose information (false as default)
-noFAKE                 close fake node & rels output , minimize output but lose information (false as default)
-noFIG                  close fig generation , save time but lose information (false as default)
-o,--output <arg>       The output file(cpg_edges.csv as default)
-p,--predefined <arg>   The predefined const file(predefined.csv as default)
-v,--verbose            verbose , report more things (0 as default)
```

**import to neo4j**

The out put file of **php2ast** and **phpast2cpg** are `nodes.csv` `fake_nodes.csv` `rels.csv` `fake_rels.csv`
and `cpg_edge.csv` (as default)

You can use neo4j-admin to import them with following command.

```shell
$ /path/to/neo4j/bin/neo4j-admin import --database=neo4j \
--nodes=nodes.csv \
--nodes=fake_nodes.csv --relationships=rels.csv \
--relationships=fake_rels.csv \
--relationships=cpg_edges.csv \
--trim-strings=true \
--skip-duplicate-nodes=true \
--skip-bad-relationships=true \
--multiline-fields=true \
--id-type=INTEGER \
--force=true
```


